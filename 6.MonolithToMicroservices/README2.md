# Выделить часть функционала монолита в микросервис

## Цель:

Подготовить документ-план распила монолита на микросервисы.

## Описание/Пошаговая инструкция выполнения домашнего задания:

0. Выбрать крупную, известную вам информационную систему, в примере по
   [ссылке](https://docs.google.com/spreadsheets/d/1Y-0ExAXsmt-tyQOgjAZv43ReCvMUR5kVcpGN1ppQWGw/edit?usp=sharing)
   представлено Яндекс.Такси. Описать ее назначение и один или несколько ее бизнес процессов
1. Определить необходимые микросервисы, и их назначение (должно быть не менее 5)
2. Описать взаимодействие сервисов в рамках одного из бизнес-сценариев. Т.е. какой микросервис с кем взаимодействует,
   какие данные передает, какие ожидает и способ взаимодействия (синхронно (какая технология?) или асинхронно (какая
   технология?)) Например, при запросе от пользователя нам необходимо: проверить не исключен ли он, затем построить
   маршрут на основе маршрута у тарификатора получить данные о стоимости и
   т.д.
3. Использовать паттерн strangler для одного из микросервисов

<b>Критерии оценки:</b><br/>
+1 балл за выполнения пункта 0<br/>
+3 балла за выполнения пункта 1<br/>
+3 балла за выполнения пункта 2<br/>

3 балла за выполнения пункта 3<br/>
Минимальный проходной балл: 7.

---

## Пункт 0. Лемана ПРО - продажа и доставка строительных материалов.

Лемана ПРО - продажа строительных материалов.
Включает в себя:
- продажу строительных материалов в специализированных магазинах
- продажу строительных материалов через сайт и мобильное приложение
- доставку строительных материалов на объект

---

## Пункт 1. Необходимые микросервисы, и их назначение.

1) $\color{#0f0}{\textsf{OrderService (Сервис заказов)}}$ - управление, оформление, и прослеживание статуса заказа.
2) $\color{#0f0}{\textsf{ClientService (Сервис клиентов)}}$ - управление аккаунтами клиентов, добавление, удаление, синхронизация с заказами.
3) $\color{#0f0}{\textsf{StoreService (Сервис хранения товаров)}}$ - учет товаров на складах магазинов.
4) $\color{#0f0}{\textsf{NotifyService (Сервис оповещения)}}$ - уведомление о статусе заказаза, рекламные рассылки. 
5) $\color{#0f0}{\textsf{DeliveryService (Сервис доставки)}}$ - управление логистикой, выделение машин под заказы, контроль доставки.

---

## Пункт 2. Описание сервисов. Описание процессов в рамках одного из бизнес-сценариев.

### Описание сервисов
1. OrderService (Сервис заказов)
   - Получение заказа с сайта (Синхронно через Rest)
   - Запрос в сервис хранения на бронирование/отмены бронирования товара (Асинхронно через брокер сообщений)
   - Оформление нового заказа при получении ответа от сервиса хранения(Асинхронно через брокер сообщений) 
   - Запрос в сервис доставки на доставку (Асинхронно через брокер сообщений).
   - Отсылка в сервис оповещения о статусе оформления товара (Асинхронно через брокер сообщений). 

2. ClientService (Сервис клиентов)
   - Получение запроса на создание клиента (Синхронно через Rest)
   - Отправка (Асинхронно через брокер сообщений) в сервис оповещения запроса подтверждения регистрации.
   - Получения подтверждения (Синхронно с сайта через Rest)
   - Регистрация пользователя для аутентификации и авторизации. 

3. StoreService (Сервис хранения товаров)
   - Выдать информацию о наличии товара (Синхронно через Rest) 
   - При получении запроса от сервиса заказов забронировать товар на определенное время, отослать ответ (Асинхронно через брокер сообщений)
   - При запросе на отгрузку товара из сервиса доставки (Асинхронно через брокер сообщений), удалить товар из склада

4. DeliveryService (Сервис доставки)
   - Получение запроса на доставку из сервиса заказов (Асинхронно через брокер сообщений).
   - Формирование доставки. Определие машины по грузоподъемности, выбор водителя.
   - Отправка в сервис оповещения сообщения о статусе доставки  

5. NotifyService (Сервис оповещения)
   - При регистрации нового клиента, отправить подтверждение регистрации на email  (Асинхронно через брокер сообщений).
   - Отправка статуса заказа из сервиса заказов при его изменении клиенту  (Асинхронно через брокер сообщений).
   - Отправка статуса доставки закакза при его формировании.


### Описание процессов в рамках одного из бизнес-сценариев.

Допустим, у нас есть бизнес-сценарий — клиент заказал строительные материалы через сайт, и требуется осуществить продажу, бронирование товара, доставку и уведомление о статусе заказа. Рассмотрим взаимодействие микросервисов в рамках этого процесса.

#### Сценарий: Заказ строительных материалов и доставка на объект
1. Создание клиента:

   - ClientService (Сервис клиентов) получает запрос на создание нового клиента через Rest API (синхронно) с сайта.
   - После регистрации клиента, сервис отправляет запрос в NotifyService (сервис оповещения) о подтверждении регистрации клиента. Это происходит асинхронно через брокер сообщений.
   - NotifyService отправляет подтверждение регистрации на email или через другие каналы уведомлений.

2. Оформление заказа:

   - Когда клиент оформляет заказ на сайте, запрос отправляется в OrderService (Сервис заказов) через Rest API (синхронно).
   - OrderService отправляет асинхронный запрос в StoreService (Сервис хранения товаров), чтобы проверить наличие товара на складе через брокер сообщений.
   -  StoreService синхронно через Rest API отправляет информацию о наличии товара, если товар есть в наличии.
   - Если товар доступен, StoreService выполняет асинхронное бронирование товара через брокер сообщений, чтобы забронировать товар на складе для данного заказа.
   - OrderService обновляет информацию о заказе и передает асинхронный запрос в DeliveryService (Сервис доставки) для планирования доставки.

3. Планирование доставки:

   - DeliveryService получает запрос от OrderService через брокер сообщений и обрабатывает его. Сервис выбора логистики решает, какой транспорт и водителя выделить для доставки.
   - DeliveryService отправляет статус доставки обратно в NotifyService через брокер сообщений, чтобы клиент мог быть уведомлен о статусе доставки.

4. Оповещения и завершение процесса:

   - NotifyService отправляет сообщения о статусе заказа клиенту через email или пуш-уведомления, используя асинхронное взаимодействие через брокер сообщений.

#### Взаимодействие микросервисов в рамках сценария:
1. ClientService ↔ NotifyService:

   - ClientService отправляет асинхронный запрос на регистрацию клиента, а NotifyService отправляет уведомление клиенту о подтверждении регистрации.
   - Взаимодействие происходит через брокер сообщений.

2. OrderService ↔ StoreService:

   - OrderService получает запрос на заказ и отправляет асинхронный запрос на бронирование товара в StoreService через брокер сообщений.
   - StoreService отвечает асинхронно и подтверждает бронирование товара.

3. OrderService ↔ DeliveryService:

   - После бронирования товара, OrderService отправляет асинхронный запрос в DeliveryService для планирования доставки.
   - DeliveryService формирует запрос, выбирает транспорт и водителя, затем отправляет статус в NotifyService.

4. NotifyService ↔ Клиент:

   - Все уведомления, такие как подтверждения заказа, статусы доставки и другие важные сообщения, отправляются через NotifyService клиенту через асинхронное взаимодействие.

#### Способ взаимодействия:
   - Синхронное взаимодействие (через Rest API) используется в случаях, когда сервисы должны получить быстрые ответы от других сервисов, например, запрос на создание клиента или информацию о наличии товара.
   - Асинхронное взаимодействие (через брокер сообщений) используется для операций, которые могут занять больше времени или не требуют немедленного ответа, например, бронирование товара, планирование доставки или отправка уведомлений.

---

## Пункт 3. Использовать паттерн strangler для одного из микросервисов.

Использование паттерна Strangler для вынесения NotifyService:

1. Current state:
   - Существующий монолитный сервис, отправляющий оповещения

2. Transition state:
   - Выделяется новый микросервис NotifyMicroservice, в него переноситься часть функционала NotifyService
   - Для "разруливания" откуда вызывать ту или иную функцию отвечает Gateway сервис - Strangler Facade

3. Final state:
   - Весь функционал переноситься в микросервис NotifyMicroservice
   - NotifyService удаляется

<img src="Images/Strangler2.png" width="800"  style="padding: 50px">