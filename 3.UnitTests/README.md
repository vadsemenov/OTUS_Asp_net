# Otus.PromoCodeFactory

Проект для домашних заданий и демо по курсу `C# ASP.NET Core Разработчик` от `Отус`.
Cистема `Promocode Factory` для выдачи промокодов партнеров для клиентов по группам предпочтений.

Для запуска проекта с базой данных `PostgreSQL` нужно использовать `docker-compose up promocode-factory-db` из корня проекта, в `Startup` файле проекта `WebHost` должна быть установлена настройка `UseNpgsql`

# Домашнее задание
Написать тесты к своему проекту и добавить их прогон в CI

Цель:
Задание поможет отработать навыки написания тестов в ASP.NET Core проектах на xUnit.
Новые требования:

1. Для нормальной работы с партнерами решили добавить в систему список партнеров и вести их активность, также будет сохраняться количество промокодов, которые выдал партнер;
2. Приняли решение для части партнеров в ручном порядке продавать подписку на использование API. Для контроля подписки вводим лимиты на выдачу промокодов для партнеров и при попытке выдать промокод будем контролировать лимиты;
3. Лимиты будем задавать и отменять через API. Лимиты должны иметь дату создания, окончания и если отменим до даты окончания, то дату отмены, а также количество промокодов в лимите.

## Описание/Пошаговая инструкция выполнения домашнего задания:

В домашнем задании нужно протестировать установку лимитов партнеру.
Тесты можно писать в файле SetPartnerPromoCodeLimitAsyncTests в проекте UnitTests.
Сделать форк репозитория домашнего задания https://github.com/OtusTeam/ASP.NET/tree/main/UnitTests и реализовать пункты в нем.
Нужно протестировать следующие Test Cases для установки партнеру (класс Partner) лимита (класс PartnerLimit) метод SetPartnerPromoCodeLimitAsync в PartnersController):

1. Если партнер не найден, то также нужно выдать ошибку 404;
2. Если партнер заблокирован, то есть поле IsActive=false в классе Partner, то также нужно выдать ошибку 400;
3. Если партнеру выставляется лимит, то мы должны обнулить количество промокодов, которые партнер выдал NumberIssuedPromoCodes, если лимит закончился, то количество не обнуляется;
4. При установке лимита нужно отключить предыдущий лимит;
5. Лимит должен быть больше 0;
6. Нужно убедиться, что сохранили новый лимит в базу данных (это нужно проверить Unit-тестом);<br>
Если в текущей реализации найдутся ошибки, то их нужно исправить и желательно написать тест, чтобы они больше не повторялись. <br>
Тесты должны соответствовать следующим условиям:
7. Использовать именование: ИмяЕдиницыТестирования_Условие_ОжидаемыйРезультат;
8. Для Arrange этапа должен использоваться фабричный метод при определении данных;
9. Для Stub и Mock использовать Moq;
10. Для создания тестируемого класса, например, PartnersController можно использовать AutoFixture (https://habr.com/ru/post/262435/), чтобы избежать ошибок компиляции при добавлении новых зависимостей в конструктор или также использовать фабричный метод;
11. Для проверки утверждения в тестах должен использоваться FluentAssertions;
12. В качестве дополнительного условия тестовые данные должны формироваться с помощью Builder, если не будет использоваться AutoFixture, то Mock и Stub также должны настраиваться через Builder;
13. В качестве дополнительного условия можно провести рефакторинг PartnersController или только метода SetPartnerPromoCodeLimitAsync на свое усмотрение, может быть ввести дополнительные классы для повышения удобства тестирования и сопровождения, если появятся дополнительные классы и методы, то они тоже должны быть протестированы, принцип расположения тестов в проекте соответствующий тестам в примере (Например, WebHost/Controllers/PartnersControllerTests); Если будет сделан рефакторинг, то при сдаче ДЗ поясните какие классы были введены;
14. В качестве дополнительного условия можно добавить прогон тестов CI в GitLab и при сдаче ДЗ прислать ссылку на прогон.

Критерии оценки:<br>
Написаны все тесты и они проходят - 6 баллов;<br>
Написаны все тесты и они соответствуют условиям с 1 по 5 - 7 баллов <br>
Написаны все тесты и они соответствуют условиям с 1 по 8 - 10 баллов <br>
Минимальный проходной порог: 6 баллов.

